# Makefile for Layer One testbench using Verilator
# Usage: make -f Makefile.verilator

# Paths
SRC_DIR = ../../src
TB_DIR = .

# Files
DUT = $(SRC_DIR)/layer_one.sv
TB = $(TB_DIR)/tb_layer_one.sv
CPP_TB = $(TB_DIR)/sim_main.cpp

# Verilator flags
VFLAGS = --cc --exe --trace-fst -Wall -Wno-fatal

# Output
TOP = tb_layer_one
EXEC = obj_dir/V$(TOP)
VERILATOR_ROOT = $(shell verilator --getenv VERILATOR_ROOT)

.PHONY: all compile run clean view

all: compile run

compile:
	@echo "Compiling with Verilator..."
	verilator $(VFLAGS) --top-module $(TOP) $(DUT) $(TB) $(CPP_TB)
	@echo "Building executable..."
	$(MAKE) -C obj_dir -f V$(TOP).mk

run: compile
	@echo "Running simulation..."
	$(EXEC)
	@echo ""
	@echo "Simulation complete! Waveform saved to layer_one.fst"
	@echo "To view waveforms: make view"

view:
	@echo "Opening waveform viewer..."
	gtkwave layer_one.fst &


help:
	@echo "Layer One Testbench Makefile"
	@echo "============================="
	@echo "make all     - Compile and run simulation"
	@echo "make compile - Compile only"
	@echo "make run     - Compile and run"
	@echo "make view    - Open waveform viewer (GTKWave)"
	@echo "make clean   - Remove generated files"
	@echo ""
	@echo "Requirements:"
	@echo "  - Verilator (simulation)"
	@echo "  - GTKWave (waveform viewing)"
