#!/usr/bin/env python3
"""
gen_mem_files.py
Generates pixels.mem and weights.mem for the top-level BNN testbench.

Weights are loaded from the real trained CSV files.
The pixel image is a synthetic 28x28 binary pattern (no MNIST file needed).

Usage:
    python3 gen_mem_files.py [digit]
        digit: 0-9, selects which synthetic digit shape to use (default: 7)
"""

import csv, os, sys

# ---------------------------------------------------------------------------
# Paths (relative to this script's location)
# ---------------------------------------------------------------------------
HERE        = os.path.dirname(os.path.abspath(__file__))
WEIGHTS_DIR = os.path.join(HERE, '../../src/Python311_training/weights')

# ---------------------------------------------------------------------------
# Synthetic 28x28 binary digit images
# Each is a list of 28 strings, each 28 chars ('0'/'1')
# ---------------------------------------------------------------------------

def _rows(*lines):
    """Pad/trim each line to exactly 28 chars and return as list of lists."""
    result = []
    for line in lines:
        row = [int(c) for c in line.ljust(28, '0')[:28]]
        result.append(row)
    while len(result) < 28:
        result.append([0]*28)
    return result

DIGITS = {
    3: _rows(# MNIST pixels from original testbench (28x28)
    "0000000000000000000000000000",  # row 0
    "0000000000000000000000000000",  # row 1
    "0000000000000000000000000000",  # row 2
    "0000000000000000000000000000",  # row 3
    "0000000000001111000000000000",  # row 4
    "0000000011111111111000000000",  # row 5
    "0000000011111111111100000000",  # row 6
    "0000000000000000001110000000",  # row 7
    "0000000000000000000110000000",  # row 8
    "0000000000000000001100000000",  # row 9
    "0000000000000111100000000000",  # row 10
    "0000000000000001100000000000",  # row 11
    "0000000111111110000000000000",  # row 12
    "0000000111111100000000000000",  # row 13
    "0000000111111000000000000000",  # row 14
    "0000000000001110000000000000",  # row 15
    "0000000000000110000000000000",  # row 16
    "0000000000000011000000000000",  # row 17
    "0000000000000011100000000000",  # row 18
    "0000000000000011000000000000",  # row 19
    "0000000000000011000000000000",  # row 20
    "0000001111100011110000000000",  # row 21
    "0000001111111111110000000000",  # row 22
    "0000000111111111000000000000",  # row 23
    "0000000000000000000000000000",  # row 24
    "0000000000000000000000000000",  # row 25
    "0000000000000000000000000000",  # row 26
    "0000000000000000000000000000",  # row 27
),
    # ---- digit 7 (fake)----
    7: _rows(
        '0000000000000000000000000000',
        '0000000000000000000000000000',
        '0000011111111111111111100000',
        '0000011111111111111111100000',
        '0000011111111111111111100000',
        '0000000000000000111110000000',
        '0000000000000001111100000000',
        '0000000000000011111000000000',
        '0000000000000111110000000000',
        '0000000000001111100000000000',
        '0000000000011111000000000000',
        '0000000000111110000000000000',
        '0000000001111100000000000000',
        '0000000011111000000000000000',
        '0000000111110000000000000000',
        '0000001111100000000000000000',
        '0000011111000000000000000000',
        '0000111110000000000000000000',
        '0001111100000000000000000000',
        '0000000000000000000000000000',
        '0000000000000000000000000000',
        '0000000000000000000000000000',
        '0000000000000000000000000000',
        '0000000000000000000000000000',
        '0000000000000000000000000000',
        '0000000000000000000000000000',
        '0000000000000000000000000000',
        '0000000000000000000000000000',
    ),
    # ---- digit 1 (fake)----
    1: _rows(
        '0000000000000000000000000000',
        '0000000000000000000000000000',
        '0000000000001111000000000000',
        '0000000000011111000000000000',
        '0000000000111111000000000000',
        '0000000000001111000000000000',
        '0000000000001111000000000000',
        '0000000000001111000000000000',
        '0000000000001111000000000000',
        '0000000000001111000000000000',
        '0000000000001111000000000000',
        '0000000000001111000000000000',
        '0000000000001111000000000000',
        '0000000000001111000000000000',
        '0000000000001111000000000000',
        '0000000000001111000000000000',
        '0000000000001111000000000000',
        '0000000000001111000000000000',
        '0000000000001111000000000000',
        '0000000000001111000000000000',
        '0000000000001111000000000000',
        '0000001111111111111100000000',
        '0000001111111111111100000000',
        '0000000000000000000000000000',
        '0000000000000000000000000000',
        '0000000000000000000000000000',
        '0000000000000000000000000000',
        '0000000000000000000000000000',
    ),
    # ---- digit 0 (fake)----
    0: _rows(
        '0000000000000000000000000000',
        '0000000000000000000000000000',
        '0000000011111111111100000000',
        '0000001111111111111111000000',
        '0000011111111111111111100000',
        '0000111110000000000111110000',
        '0001111100000000000011111000',
        '0001111100000000000011111000',
        '0011111000000000000001111100',
        '0011111000000000000001111100',
        '0011111000000000000001111100',
        '0011111000000000000001111100',
        '0011111000000000000001111100',
        '0011111000000000000001111100',
        '0011111000000000000001111100',
        '0011111000000000000001111100',
        '0001111100000000000011111000',
        '0001111100000000000011111000',
        '0000111110000000000111110000',
        '0000011111111111111111100000',
        '0000001111111111111111000000',
        '0000000011111111111100000000',
        '0000000000000000000000000000',
        '0000000000000000000000000000',
        '0000000000000000000000000000',
        '0000000000000000000000000000',
        '0000000000000000000000000000',
        '0000000000000000000000000000',
    ),
        8: _rows(
        '0000000000000000000000000000',
        '0000000000000000000000000000',
        '0000000000000000000000000000',
        '0000000000000000000000000000',
        '0000000000000000000000000000',
        '0000000000000000000000000000',
        '0000000000000000000000000000',
        '0000000000000000000000000000',
        '0000000000000000000000000000',
        '0000000000000000000000000000',
        '0000000000000000000000000000',
        '0000000000000000000000000000',
        '0000000000000000000000000000',
        '0000000000000000000000000000',
        '0000000000000000000000000000',
        '0000000000000000000000000000',
        '0000000000000000000000000000',
        '0000000000000000000000000000',
        '0000000000000000000000000000',
        '0000000000000000000000000000',
        '0000000000000000000000000000',
        '0000000000000000000000000000',
        '0000000000000000000000000000',
        '0000000000000000000000000000',
        '0000000000000000000000000000',
        '0000000000000000000000000000',
        '0000000000000000000000000000',
        '0000000000000000000000000000',
    ),
    6: _rows(
        '1111111111111111111111111111',
        '1111111111111111111111111111',
        '1111111111111111111111111111',
        '1111111111111111111111111111',
        '1111111111111111111111111111',
        '1111111111111111111111111111',
        '1111111111111111111111111111',
        '1111111111111111111111111111',
        '1111111111111111111111111111',
        '1111111111111111111111111111',
        '1111111111111111111111111111',
        '1111111111111111111111111111',
        '1111111111111111111111111111',
        '1111111111111111111111111111',
        '1111111111111111111111111111',
        '1111111111111111111111111111',
        '1111111111111111111111111111',
        '1111111111111111111111111111',
        '1111111111111111111111111111',
        '1111111111111111111111111111',
        '1111111111111111111111111111',
        '1111111111111111111111111111',
        '1111111111111111111111111111',
        '1111111111111111111111111111',
        '1111111111111111111111111111',
        '1111111111111111111111111111',
        '1111111111111111111111111111',
        '1111111111111111111111111111',
    ),
}
# Default for any other digit: checkerboard
def _checkerboard():
    return [[(r+c)%2 for c in range(28)] for r in range(28)]

# ---------------------------------------------------------------------------
# Weight stream builders (must match registers.sv capture order)
# ---------------------------------------------------------------------------

def load_csv(path):
    rows = []
    with open(path, newline='') as f:
        for line in csv.reader(f):
            rows.append([int(x) for x in line])
    return rows

def build_w1(w1_csv):
    """72 bits: level(0-7) outer, trit(0-2), bitt(0-2) inner."""
    bits = []
    for level in range(8):
        for trit in range(3):
            for bitt in range(3):
                bits.append(w1_csv[level][trit*3 + bitt])
    return bits

def build_w2(w2_csv):
    """288 bits: level1(0-3) outer, j(0-71) inner [=(kr*3+kc)*8+ch]."""
    bits = []
    for level1 in range(4):
        for j in range(72):
            bits.append(w2_csv[level1][j])
    return bits

def build_w3(w3_csv):
    """1960 bits: neuron(0-9) outer, bit(0-195) inner."""
    bits = []
    for neuron in range(10):
        for b in range(196):
            bits.append(w3_csv[neuron][b])
    return bits

# ---------------------------------------------------------------------------
# Main
# ---------------------------------------------------------------------------

def main():
    digit = int(sys.argv[1]) if len(sys.argv) > 1 else 7
    image = DIGITS.get(digit, _checkerboard())

    # Print ASCII preview
    print(f"Generating test for synthetic digit '{digit}'")
    print("Input image (# = white, . = black):")
    print("+" + "-"*28 + "+")
    for row in image:
        print("|" + "".join("#" if p else "." for p in row) + "|")
    print("+" + "-"*28 + "+")

    # Pixel stream: row outer, col inner
    pixel_bits = []
    for row in image:
        pixel_bits.extend(row)
    assert len(pixel_bits) == 784

    # Weight streams from CSV
    w1 = load_csv(os.path.join(WEIGHTS_DIR, 'layer_0_weights.csv'))
    w2 = load_csv(os.path.join(WEIGHTS_DIR, 'layer_3_weights.csv'))
    w3 = load_csv(os.path.join(WEIGHTS_DIR, 'layer_7_weights.csv'))

    weight_bits = build_w1(w1) + build_w2(w2) + build_w3(w3)
    assert len(weight_bits) == 2320

    # Write .mem files (one bit per line, $readmemb compatible)
    with open(os.path.join(HERE, 'pixels.mem'), 'w') as f:
        for b in pixel_bits:
            f.write(f"{b}\n")

    with open(os.path.join(HERE, 'weights.mem'), 'w') as f:
        for b in weight_bits:
            f.write(f"{b}\n")

    print(f"Written pixels.mem  ({len(pixel_bits)} bits)")
    print(f"Written weights.mem ({len(weight_bits)} bits)")
    print("Ready to simulate.")

if __name__ == '__main__':
    main()
